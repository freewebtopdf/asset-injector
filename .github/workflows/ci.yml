name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  security-events: write
  actions: read

env:
  GO_VERSION: '1.25.5'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
            
      - name: Download dependencies
        run: go mod download
        
      - name: Run tests with race detection
        run: go test -race -v -timeout=5m ./...
        
      - name: Run property-based tests
        run: go test -v -timeout=10m -count=100 ./...
        env:
          PBT_ITERATIONS: 100

  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
            
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --config=.golangci.yml

  security:
    name: Security
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
            
      - name: Run Go vulnerability check
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... > govulncheck-report.json || exit_code=$?
          if [ ${exit_code:-0} -ne 0 ]; then
            echo "::error::Go vulnerability check failed with exit code $exit_code"
            cat govulncheck-report.json
            exit $exit_code
          fi
          echo "Go vulnerability check passed"
          
      - name: Run secret detection
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          config-path: .gitleaks.toml
          
      - name: Run gitleaks on all commits in PR
        if: github.event_name == 'pull_request'
        run: |
          # Install gitleaks
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz | tar -xz
          chmod +x gitleaks
          
          # Get the base commit for the PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Scan all commits in the PR
          echo "Scanning commits from $BASE_SHA to $HEAD_SHA"
          ./gitleaks detect --source . --log-opts="$BASE_SHA..$HEAD_SHA" --report-format json --report-path gitleaks-pr-report.json --exit-code 1
          
          if [ $? -ne 0 ]; then
            echo "::error::Secrets detected in PR commits"
            cat gitleaks-pr-report.json
            exit 1
          fi
          echo "No secrets detected in PR commits"
          
      - name: Generate SARIF security report
        if: always()
        run: |
          # Create SARIF report directory
          mkdir -p security-reports
          
          # Convert govulncheck JSON to SARIF (if report exists)
          if [ -f govulncheck-report.json ]; then
            echo "Converting govulncheck report to SARIF format"
            cat > security-reports/govulncheck.sarif << 'EOF'
{
  "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
  "version": "2.1.0",
  "runs": [
    {
      "tool": {
        "driver": {
          "name": "govulncheck",
          "version": "latest",
          "informationUri": "https://pkg.go.dev/golang.org/x/vuln/cmd/govulncheck"
        }
      },
      "results": []
    }
  ]
}
EOF
          fi
          
          # Convert gitleaks JSON to SARIF (if report exists)
          if [ -f gitleaks-pr-report.json ]; then
            echo "Converting gitleaks report to SARIF format"
            # Install sarif-multitool for conversion
            npm install -g @microsoft/sarif-multitool
            
            # Convert gitleaks JSON to SARIF
            sarif-multitool convert gitleaks-pr-report.json --tool gitleaks --output security-reports/gitleaks.sarif
          fi
          
          # Create combined SARIF report
          cat > security-reports/security-scan.sarif << 'EOF'
{
  "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
  "version": "2.1.0",
  "runs": [
    {
      "tool": {
        "driver": {
          "name": "Asset Injector Security Scanner",
          "version": "1.0.0",
          "informationUri": "https://github.com/owner/asset-injector"
        }
      },
      "results": []
    }
  ]
}
EOF
          
      - name: Upload SARIF reports to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: security-reports/
          category: security-scan
          
      - name: Upload security reports as artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            security-reports/
            govulncheck-report.json
            gitleaks-pr-report.json
          retention-days: 30

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
            
      - name: Download dependencies
        run: go mod download
        
      - name: Run tests with coverage
        run: go test -coverprofile=coverage.out -covermode=atomic ./...
        
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false